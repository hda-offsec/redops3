{% extends "base.html" %}

{% block title %}Operation #{{ scan.id }}{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="card panel-card">
            <div class="card-header panel-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-satellite-dish me-2"></i>Operation Overview</span>
                <div>
                    <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-outline-cyber me-2">
                        <i class="fas fa-home"></i> Mission Control
                    </a>
                    <div class="mission-ops d-flex gap-2">
                        <a href="{{ url_for('main.scan_report', scan_id=scan.id, format='pdf') }}" target="_blank"
                            class="btn btn-xs btn-outline-cyber">
                            <i class="fas fa-file-pdf me-1"></i>Generate PDF
                        </a>
                        <a href="{{ url_for('main.scan_osint', scan_id=scan.id) }}" class="btn btn-xs btn-outline-info">
                            <i class="fas fa-search-plus me-1"></i>OSINT Intel
                        </a>
                        <button class="btn btn-xs btn-outline-warning" data-bs-toggle="modal"
                            data-bs-target="#lootModal">
                            <i class="fas fa-hand-holding-usd me-1"></i>Harvest Loot
                        </button>
                    </div>
                    <span class="badge status-pill status-{{ scan.status }}">{{ scan.status }}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="meta-label">Target</div>
                        <div class="meta-value">{{ scan.target.identifier }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="meta-label">Type</div>
                        <div class="meta-value text-uppercase">{{ scan.scan_type }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="meta-label">Start</div>
                        <div class="meta-value">{{ scan.start_time.strftime('%H:%M:%S') }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="meta-label">End</div>
                        <div class="meta-value">{% if scan.end_time %}{{ scan.end_time.strftime('%H:%M:%S') }}{% else
                            %}—{% endif %}</div>
                    </div>
                </div>
                <div class="severity-strip mt-4">
                    <div class="severity-item critical">Critical {{ severity_counts['critical'] }}</div>
                    <div class="severity-item high">High {{ severity_counts['high'] }}</div>
                    <div class="severity-item medium">Medium {{ severity_counts['medium'] }}</div>
                    <div class="severity-item low">Low {{ severity_counts['low'] }}</div>
                    <div class="severity-item info">Info {{ severity_counts['info'] }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="row g-4">
            <!-- NETWORK MAP VISUALIZATION -->
            <div class="col-12">
                <div class="card panel-card">
                    <div class="card-header panel-header"><i class="fas fa-project-diagram me-2"></i>Attack Surface Map
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="network-graph" style="height: 400px; background: #111; border-radius: 0 0 4px 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RECON MATRIX -->
            <div class="col-12">
                <div class="card panel-card">
                    <div class="card-header panel-header"><i class="fas fa-th me-2"></i>Recon Matrix (Deep Audit)</div>
                    <div class="card-body p-0">
                        {% if results and results.phases and results.phases.recon and results.phases.recon.open_ports %}
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0"
                                style="border-collapse: separate; border-spacing: 0;">
                                <thead style="background: #222;">
                                    <tr class="text-muted small text-uppercase">
                                        <th class="p-3">Service</th>
                                        <th class="p-3">Risk Score</th>
                                        <th class="p-3">Port</th>
                                        <th class="p-3">Version Fingerprint</th>
                                        <th class="p-3">Context / Technology</th>
                                        <th class="p-3 text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recon-matrix-body">
                                    {% for port in results.phases.recon.open_ports|sort(attribute='priority_score',
                                    reverse=True) %}
                                    <tr
                                        style="border-bottom: 1px solid #333; height: 65px; vertical-align: middle; {% if port.priority_score and port.priority_score >= 80 %}background: rgba(255, 42, 42, 0.05);{% endif %}">
                                        <td class="p-3">
                                            <span
                                                class="badge bg-secondary-subtle text-secondary border border-secondary-subtle text-uppercase"
                                                style="font-size: 0.72rem; letter-spacing: 0.5px;">
                                                <i class="fas fa-server me-1 opacity-50"></i>{{ port.service_name }}
                                            </span>
                                        </td>
                                        <td class="p-3">
                                            {% set score = port.priority_score or 0 %}
                                            <div class="d-flex align-items-center">
                                                <div class="progress bg-dark border border-secondary"
                                                    style="height: 6px; width: 40px; margin-right: 10px;">
                                                    <div class="progress-bar {% if score >= 85 %}bg-danger shadow-danger{% elif score >= 50 %}bg-warning{% else %}bg-info{% endif %}"
                                                        role="progressbar" style="width: {{ score }}%"></div>
                                                </div>
                                                <span
                                                    class="badge {% if score >= 85 %}text-danger fw-bold{% elif score >= 50 %}text-warning{% else %}text-info{% endif %} font-monospace"
                                                    style="font-size: 0.8rem;">
                                                    {{ score }}<small class="opacity-50">/100</small>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="p-3">
                                            <code class="text-info fw-bold"
                                                style="font-size: 0.9rem; background: rgba(0,240,255,0.05); padding: 2px 6px; border-radius: 4px;">{{ port.port }}/tcp</code>
                                        </td>
                                        <td class="p-3">
                                            {% if port.version and port.version != "Unknown" %}
                                            <span class="text-light opacity-75 small font-monospace">{{ port.version
                                                }}</span>
                                            {% else %}
                                            <span class="text-muted fst-italic small">Fingerprinting...</span>
                                            {% endif %}
                                        </td>
                                        <td class="p-3">
                                            {% set port_key = port.port|string %}
                                            {% if results.phases.enum and results.phases.enum.whatweb and
                                            results.phases.enum.whatweb[port_key] %}
                                            {% set ww = results.phases.enum.whatweb[port_key] %}
                                            <div class="d-flex flex-wrap gap-2">
                                                {% if "Title[" in ww %}
                                                <span
                                                    class="badge rounded-pill bg-dark border border-secondary text-info shadow-sm py-1 px-2"
                                                    title="HTML Page Title">
                                                    <i class="fas fa-heading me-1 opacity-50"></i>{{
                                                    ww.split('Title[')[1].split(']')[0] }}
                                                </span>
                                                {% endif %}
                                                {% if "HTTPServer[" in ww %}
                                                <span
                                                    class="badge rounded-pill bg-dark border border-secondary text-warning shadow-sm py-1 px-2">
                                                    <i class="fas fa-microchip me-1 opacity-50"></i>{{
                                                    ww.split('HTTPServer[')[1].split(']')[0] }}
                                                </span>
                                                {% endif %}
                                                {% if "Cloudflare" in ww %}
                                                <span
                                                    class="badge rounded-pill bg-info-subtle text-info border border-info-subtle py-1 px-2"><i
                                                        class="fab fa-cloudflare me-1"></i>WAF</span>
                                                {% endif %}
                                            </div>
                                            {% else %}
                                            <span class="text-muted small">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="p-3 text-end">
                                            {% if 'http' in port.service_name or port.port in [80, 443, 8080, 8443] %}
                                            {% set proto = 'https' if port.port in [443, 8443] else 'http' %}
                                            <a href="{{ proto }}://{{ scan.target.identifier }}:{{ port.port }}"
                                                target="_blank" class="btn btn-xs btn-outline-info"
                                                title="Visit Web Service">
                                                <i class="fas fa-external-link-alt me-1"></i>Visit
                                            </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-search fa-2x mb-3"></i>
                            <p>No attack surface identified yet. Scan in progress or target unresponsive.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>

        <div class="col-12">
            <div class="card panel-card">
                <div class="card-header panel-header"><i class="fas fa-list-ul me-2"></i>Enumeration (WhatWeb)</div>
                <div class="card-body">
                    {% if results %}
                    {% set summary = results.get('phases', {}).get('enum', {}).get('whatweb', {}).get('summary', {})
                    %}
                    {% if summary %}
                    <div class="tag-grid">
                        {% for key, value in summary.items() %}
                        <div class="tag-item">
                            <span class="tag-key">{{ key }}</span>
                            <span class="tag-value">{{ value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted">No enumeration summary available.</div>
                    {% endif %}
                    {% else %}
                    <div class="text-muted">No structured results available.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card panel-card">
                <div class="card-header panel-header"><i class="fas fa-bug me-2"></i>Vulnerability Mapping (Nuclei)
                </div>
                <div class="card-body">
                    {% if results %}
                    {% set vuln_findings = results.get('phases', {}).get('vuln', {}).get('nuclei',
                    {}).get('findings', []) %}
                    {% if vuln_findings %}
                    <div class="result-list">
                        {% for finding in vuln_findings %}
                        <div class="result-row">
                            <span class="badge severity-badge {{ finding.severity }}">{{ finding.severity }}</span>
                            <span class="result-text">{{ finding.title }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted">No vulnerabilities reported.</div>
                    {% endif %}
                    {% else %}
                    <div class="text-muted">No structured results available.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card panel-card">
                <div class="card-header panel-header"><i class="fas fa-folder-open me-2"></i>Dirbusting (ffuf)</div>
                <div class="card-body">
                    {% if results %}
                    {% set endpoints = results.get('phases', {}).get('dirbusting', {}).get('ffuf',
                    {}).get('endpoints', []) %}
                    {% if endpoints %}
                    <div class="result-list">
                        {% for endpoint in endpoints %}
                        <div class="result-row">
                            <span class="badge bg-secondary">/{{ endpoint.path }}</span>
                            <span class="result-text">Status {{ endpoint.status }} · Size {{ endpoint.size }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted">No endpoints discovered.</div>
                    {% endif %}
                    {% else %}
                    <div class="text-muted">No structured results available.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="col-lg-4">
    <!-- RAW OUTPUT (DEBUG) -->
    <div class="card panel-card mb-4 text-secondary" style="font-size: 0.8rem;">
        <div class="card-header panel-header py-1" data-bs-toggle="collapse" data-bs-target="#rawOutput"
            style="cursor: pointer; opacity: 0.7;">
            <i class="fas fa-terminal me-2"></i>Raw Nmap View
        </div>
        <div id="rawOutput" class="collapse">
            <div class="card-body bg-black p-2">
                {% if results and results.phases and results.phases.recon and results.phases.recon.raw_output %}
                <pre class="m-0"
                    style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; font-size: 0.7rem;">{{ results.phases.recon.raw_output }}</pre>
                {% else %}
                <div class="text-muted">No raw output captured yet.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card panel-card mb-4">
        <div class="card-header panel-header"><i class="fas fa-bell me-2"></i>Findings</div>
        <div class="card-body">
            {% if findings %}
            <div class="result-list">
                {% for finding in findings %}
                <div class="result-row flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <span class="badge severity-badge {{ finding.severity }}">{{ finding.severity }}</span>
                        <span class="result-text fw-bold">{{ finding.title }}</span>
                    </div>
                    {% if finding.screenshot_path %}
                    <div class="mt-2 w-100">
                        <img src="{{ url_for('static', filename=finding.screenshot_path) }}"
                            class="img-fluid rounded border border-secondary shadow-sm"
                            style="max-height: 150px; cursor: pointer;" onclick="window.open(this.src)">
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">No findings recorded.</div>
            {% endif %}
        </div>
    </div>

    <div class="card panel-card mb-4">
        <div class="card-header panel-header"><i class="fas fa-lightbulb me-2"></i>Suggestions</div>
        <div class="card-body">
            {% if suggestions %}
            <div class="result-list">
                {% for suggestion in suggestions %}
                <div class="result-row d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-secondary me-2">{{ suggestion.tool_name }}</span>
                        <span class="result-text font-monospace small">{{ suggestion.command_suggestion }}</span>
                    </div>
                    <button class="btn btn-xs btn-outline-warning"
                        onclick='verifyFinding({{ suggestion.command_suggestion|tojson|safe }})'>
                        <i class="fas fa-play me-1"></i>Verify
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">No suggestions recorded.</div>
            {% endif %}
        </div>
    </div>

    <div class="card panel-card mb-4">
        <div class="card-header panel-header"><i class="fas fa-sticky-note me-2"></i>Operator Notes (War Room)</div>
        <div class="card-body">
            <form action="{{ url_for('main.update_notes', scan_id=scan.id) }}" method="POST">
                <textarea name="notes" class="form-control bg-dark text-light border-secondary mb-2" rows="6"
                    placeholder="Document your findings, false positives, or next steps here...">{{ scan.notes or '' }}</textarea>
                <div class="text-end">
                    <button type="submit" class="btn btn-sm btn-outline-success">Save Notes</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card panel-card">
        <div class="card-header panel-header"><i class="fas fa-terminal me-2"></i>Execution Log</div>
        <div class="card-body font-monospace log-console">
            {% if logs %}
            {% for log in logs %}
            <div>
                <span class="text-muted">[{{ log.timestamp.strftime('%H:%M:%S') }}]</span>
                <span
                    class="{% if log.level == 'INFO' %}text-secondary{% elif log.level == 'SUCCESS' %}text-success{% elif log.level == 'WARN' %}text-warning{% elif log.level == 'ERROR' %}text-danger{% else %}text-secondary{% endif %}">{{
                    log.level }}</span>
                {{ log.message }}
            </div>
            {% endfor %}
            {% else %}
            <div class="text-muted">No logs recorded.</div>
            {% endif %}
        </div>
    </div>
</div>
</div>

<!-- Harvest Loot Modal -->
<div class="modal fade" id="harvestLootModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning"><i class="fas fa-sack-dollar me-2"></i>Harvest Mission Loot</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.loot_add', scan_id=scan.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Loot Type</label>
                        <select name="type" class="form-select bg-black text-light border-secondary">
                            <option value="credential">Credential (User/Pass)</option>
                            <option value="token">Token / API Key</option>
                            <option value="file">Sensitive File Path</option>
                            <option value="other">Other Asset</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Content</label>
                        <textarea name="content"
                            class="form-control bg-black text-light border-secondary font-monospace" rows="2"
                            placeholder="admin:P@ssword123" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Context (Where did you find it?)</label>
                        <input type="text" name="context" class="form-control bg-black text-light border-secondary"
                            placeholder="e.g. /etc/passwd or login form">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-warning">Store in Vault</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="nodeDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title font-monospace text-info" id="nodeDetailTitle">Node Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body" id="nodeDetailBody">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>
</div>

<!-- Vis.js & Markdown Libraries -->
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const scanId = "{{ scan.id }}";
        const targetLabel = "{{ scan.target.identifier }}";
        const socket = io();

        console.log("Initializing Real-Time Sync for Scan #" + scanId);

        // --- NETWORK GRAPH INITIALIZATION ---
        let network = null;
        let nodes = new vis.DataSet([]);
        let edges = new vis.DataSet([]);

        function initGraph() {
            const container = document.getElementById("network-graph");
            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: {
                    borderWidth: 2,
                    shadow: true,
                    font: { color: "#fff", face: "Space Grotesk" }
                },
                edges: {
                    smooth: { type: 'continuous' }
                },
                physics: {
                    stabilization: false,
                    barnesHut: { gravitationalConstant: -3000, springConstant: 0.04, springLength: 95 }
                },
                interaction: { hover: true, zoomView: true }
            };
            network = new vis.Network(container, data, options);

            // Handle Node Clicks
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    showNodeDetails(nodeId);
                }
            });
        }

        function showNodeDetails(nodeId) {
            const node = nodes.get(nodeId);
            const title = document.getElementById("nodeDetailTitle");
            const body = document.getElementById("nodeDetailBody");

            title.innerText = node.label.replace("\n", " ");

            let content = `<div class="p-4">`;
            if (nodeId.toString().startsWith('p')) {
                const portNum = nodeId.replace('p', '');
                content += `
                    <div class="d-flex align-items-center mb-4">
                        <div class="display-4 text-info fw-bold me-3">${portNum}</div>
                        <div>
                            <div class="text-uppercase text-muted small">Port Status</div>
                            <div class="badge bg-success">OPEN / ACTIVE</div>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="p-3 bg-black rounded border border-secondary text-center">
                                <i class="fas fa-server fa-2x text-secondary mb-2"></i>
                                <div class="small text-muted">Service</div>
                                <div class="fw-bold">${node.label.split('\n')[1] || 'Unknown'}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-black rounded border border-secondary text-center">
                                <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
                                <div class="small text-muted">Risk Profile</div>
                                <div class="fw-bold text-warning">HIGH</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h6 class="text-secondary small text-uppercase">Recommended Action</h6>
                        <div class="alert alert-info border-info-subtle bg-info-subtle text-info-emphasis py-2 small">
                            Check "Intelligence" section for specific CVE payloads and TTPs for this port.
                        </div>
                    </div>
                `;
            } else if (nodeId.toString().startsWith('v')) {
                content += `
                    <div class="text-center mb-4">
                        <i class="fas fa-microchip fa-3x text-success mb-3"></i>
                        <h5>Service Version Found</h5>
                        <div class="font-monospace text-success h4">${node.label}</div>
                    </div>
                    <p class="text-muted">Exact version match found via Nmap fingerprinting. Used by the Intelligence Engine to map potential CVEs.</p>
                 `;
            } else {
                content += `<div class="text-center py-4"><i class="fas fa-bullseye fa-3x text-danger mb-3"></i><h4>Target Identification</h4><p class="text-muted">${node.label}</p></div>`;
            }
            content += `</div>`;

            body.innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('nodeDetailModal'));
            modal.show();
        }

        // --- DATA SYNC LOGIC ---
        function updateUI(results) {
            if (!results || !results.phases) return;

            // 1. Update Recon Matrix (Table)
            const matrixBody = document.querySelector("#recon-matrix-body");
            if (matrixBody && results.phases.recon && results.phases.recon.open_ports) {
                let html = "";
                const ports = results.phases.recon.open_ports.sort((a, b) => (b.priority_score || 0) - (a.priority_score || 0));

                ports.forEach(port => {
                    const score = port.priority_score || 0;
                    const scoreClass = score >= 85 ? 'text-danger fw-bold' : (score >= 50 ? 'text-warning' : 'text-info');
                    const barClass = score >= 85 ? 'bg-danger shadow-danger' : (score >= 50 ? 'bg-warning' : 'bg-info');
                    const bgStyle = score >= 85 ? 'background: rgba(255, 42, 42, 0.05);' : '';

                    html += `<tr style="border-bottom: 1px solid #333; height: 65px; vertical-align: middle; ${bgStyle}">
                        <td class="p-3"><span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle text-uppercase"><i class="fas fa-server me-1 opacity-50"></i>${port.service_name}</span></td>
                        <td class="p-3">
                            <div class="d-flex align-items-center">
                                <div class="progress bg-dark border border-secondary" style="height: 6px; width: 40px; margin-right: 10px;">
                                    <div class="progress-bar ${barClass}" style="width: ${score}%"></div>
                                </div>
                                <span class="badge ${scoreClass} font-monospace">${score}<small class="opacity-50">/100</small></span>
                            </div>
                        </td>
                        <td class="p-3"><code class="text-info fw-bold">${port.port}/tcp</code></td>
                        <td class="p-3"><span class="text-light opacity-75 small font-monospace">${port.version || '-'}</span></td>
                        <td class="p-3"><span class="text-muted small">Updated via live sync</span></td>
                        <td class="p-3 text-end">
                            ${(port.port == 80 || port.port == 443 || port.port == 8080) ? `<a href="http://${targetLabel}:${port.port}" target="_blank" class="btn btn-xs btn-outline-info"><i class="fas fa-external-link-alt"></i></a>` : ''}
                        </td>
                    </tr>`;
                });
                matrixBody.innerHTML = html;
            }

            // 2. Update Graph Nodes
            if (results.phases.recon && results.phases.recon.open_ports) {
                if (!network) initGraph();

                // Add Target Node if missing
                if (!nodes.get(0)) nodes.add({ id: 0, label: targetLabel, color: "#ff2a2a", shape: "hexagon", size: 40 });

                results.phases.recon.open_ports.forEach(port => {
                    const pId = "p" + port.port;
                    if (!nodes.get(pId)) {
                        nodes.add({ id: pId, label: port.port + "\n" + port.service_name, color: "#00f0ff", shape: "dot", size: 15 });
                        edges.add({ from: 0, to: pId, color: { color: "#333" } });
                    }
                    if (port.version && port.version !== "Unknown") {
                        const vId = "v" + port.port;
                        if (!nodes.get(vId)) {
                            nodes.add({ id: vId, label: port.version, color: "#0f0", shape: "box", font: { color: "#000", size: 11 } });
                            edges.add({ from: pId, to: vId, length: 100 });
                        }
                    }
                });
            }
        }

        // --- SOCKET LISTENERS ---
        socket.on("results_update", function (msg) {
            if (msg.scan_id == scanId) {
                console.log("Results updated received.");
                updateUI(msg.data);
            }
        });

        socket.on("new_log", function (data) {
            if (data.scan_id == scanId) {
                const consoleDiv = document.querySelector(".log-console");
                const div = document.createElement("div");
                const levelClass = data.level === 'SUCCESS' ? 'text-success' : (data.level === 'WARN' ? 'text-warning' : (data.level === 'ERROR' ? 'text-danger' : 'text-secondary'));
                div.innerHTML = `<span class="text-muted">[${data.timestamp}]</span> <span class="${levelClass}">${data.level}</span> ${data.message}`;
                consoleDiv.prepend(div);
            }
        });

        // Initial render
        {% if results %}
        const initialResults = {{ results| tojson | safe
    }};
    updateUI(initialResults);
    {% endif %}

    // --- VERIFICATION LOGIC ---
    window.verifyFinding = function (command) {
        console.log("Triggering verification for: " + command);
        fetch('/scan/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scan_id: scanId, command: command })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Small toast or notification could go here
                }
            });
    };

    // --- COLLABORATIVE NOTES (MARKDOWN) ---
    const notesTextarea = document.querySelector('textarea[name="notes"]');
    if (notesTextarea) {
        // Add Toolbar
        const toolbar = document.createElement('div');
        toolbar.className = "mb-2 btn-group";
        toolbar.innerHTML = `
                <button type="button" class="btn btn-xs btn-outline-secondary" onclick="insertAtCursor('### ')">H3</button>
                <button type="button" class="btn btn-xs btn-outline-secondary" onclick="insertAtCursor('- [ ] ')">Task</button>
                <button type="button" class="btn btn-xs btn-outline-secondary" onclick="insertAtCursor('\`\`\`bash\\n\\n\`\`\`')">Code</button>
            `;
        notesTextarea.parentNode.insertBefore(toolbar, notesTextarea);

        window.insertAtCursor = function (text) {
            const start = notesTextarea.selectionStart;
            const end = notesTextarea.selectionEnd;
            notesTextarea.value = notesTextarea.value.substring(0, start) + text + notesTextarea.value.substring(end);
            notesTextarea.focus();
            notesTextarea.selectionStart = notesTextarea.selectionEnd = start + text.length;
            updatePreview();
        };

        const previewHeader = document.createElement('div');
        previewHeader.className = "d-flex justify-content-between align-items-center mb-2 mt-3";
        previewHeader.innerHTML = `<h6 class="mb-0 text-secondary small"><i class="fas fa-eye me-2"></i>Operator Brief Preview</h6>
                                          <span class="badge bg-secondary-subtle text-secondary" style="font-size: 0.6rem;">MARKDOWN LIVE</span>`;

        const previewDiv = document.createElement('div');
        previewDiv.className = "markdown-preview p-3 bg-black rounded border border-secondary text-light mb-3";
        previewDiv.style.minHeight = "120px";
        previewDiv.style.fontSize = "0.85rem";

        notesTextarea.parentNode.insertBefore(previewHeader, notesTextarea.nextSibling);
        previewHeader.parentNode.insertBefore(previewDiv, previewHeader.nextSibling);

        function updatePreview() {
            previewDiv.innerHTML = marked.parse(notesTextarea.value || "*No mission notes recorded yet.*");
        }

        notesTextarea.addEventListener('input', updatePreview);
        updatePreview();
    }
    });
</script>
{% endblock %}