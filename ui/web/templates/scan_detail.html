{% extends "base.html" %}

{% block title %}Operation #{{ scan.id }}{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- HEADER / OVERVIEW PANEL -->
    <div class="col-12">
        <div class="card glass-panel">
            <div class="card-header glass-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-satellite-dish me-2"></i>Operation Overview: <span class="text-cyber">{{
                        scan.target.identifier }}</span></span>
                <div class="mission-ops d-flex gap-2">
                    <a href="{{ url_for('main.index') }}" class="btn btn-xs btn-outline-cyber">
                        <i class="fas fa-home me-1"></i>Home
                    </a>
                    <a href="{{ url_for('main.scan_report', scan_id=scan.id, format='pdf') }}" target="_blank"
                        class="btn btn-xs btn-outline-cyber">
                        <i class="fas fa-file-pdf me-1"></i>Report
                    </a>
                    <a href="{{ url_for('main.scan_osint', scan_id=scan.id) }}" class="btn btn-xs btn-outline-info">
                        <i class="fas fa-search-plus me-1"></i>OSINT
                    </a>
                    <button class="btn btn-xs btn-outline-warning" data-bs-toggle="modal"
                        data-bs-target="#harvestLootModal">
                        <i class="fas fa-hand-holding-usd me-1"></i>Loot
                    </button>
                    <span class="badge status-pill status-{{ scan.status }} ms-2">{{ scan.status }}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="meta-label text-muted small text-uppercase">Type</div>
                        <div class="meta-value text-uppercase fw-bold">{{ scan.scan_type }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="meta-label text-muted small text-uppercase">Duration</div>
                        <div class="meta-value font-monospace">
                            {% if scan.end_time and scan.start_time %}
                            {{ (scan.end_time - scan.start_time)|string|truncate(7, true, '') }}
                            {% else %}
                            Running...
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="meta-label text-muted small text-uppercase mb-1">Live Progress</div>
                        <div class="d-flex align-items-center mb-1">
                            <div class="spinner-border spinner-border-sm text-cyber me-2 {% if scan.status != 'running' %}d-none{% endif %}"
                                id="scan-spinner" role="status"></div>
                            <span class="meta-value font-monospace text-uppercase small" id="scan-status-text">{{
                                scan.status }}</span>
                            <span class="ms-auto small font-monospace text-muted"
                                id="scan-phase-text">initializing...</span>
                        </div>
                        <div class="progress bg-dark border border-secondary" style="height: 6px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-cyber"
                                id="scan-progress-bar" role="progressbar"
                                style="width: {% if scan.status == 'completed' %}100{% elif scan.status == 'running' %}5{% else %}0{% endif %}%">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="severity-strip mt-4 d-flex gap-1 flex-wrap">
                    <div
                        class="severity-item critical px-3 py-1 bg-black border border-danger text-danger rounded-1 small fw-bold">
                        CRITICAL: {{ severity_counts['critical'] }}
                    </div>
                    <div
                        class="severity-item high px-3 py-1 bg-black border border-warning text-warning rounded-1 small fw-bold">
                        HIGH: {{ severity_counts['high'] }}
                    </div>
                    <div
                        class="severity-item medium px-3 py-1 bg-black border border-info text-info rounded-1 small fw-bold">
                        MEDIUM: {{ severity_counts['medium'] }}
                    </div>
                    <div
                        class="severity-item low px-3 py-1 bg-black border border-secondary text-secondary rounded-1 small fw-bold">
                        LOW: {{ severity_counts['low'] }}
                    </div>
                    <div
                        class="severity-item info px-3 py-1 bg-black border border-secondary text-muted rounded-1 small">
                        INFO: {{ severity_counts['info'] }}
                    </div>
                </div>

                {% if scan.geolocation_data %}
                <div class="mt-4 p-3 bg-black border border-secondary rounded shadow-sm">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <i class="fas fa-globe-africa fa-2x text-cyber"></i>
                        </div>
                        <div class="col-md-11">
                            <h6 class="text-uppercase small text-muted mb-1">Geographical Intelligence</h6>
                            <div class="d-flex gap-4">
                                <div class="font-monospace small"><span class="text-muted">LOCATION:</span> {{
                                    scan.geolocation_data.city }}, {{ scan.geolocation_data.country }}</div>
                                <div class="font-monospace small"><span class="text-muted">ISP:</span> {{
                                    scan.geolocation_data.isp }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD CONTENT -->
    <div class="col-lg-8">
        <div class="row g-4">
            <!-- NETWORK MAP VISUALIZATION -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-project-diagram me-2"></i>Attack Surface Map
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="network-graph"
                            style="height: 400px; background: rgba(0,0,0,0.5); border-radius: 0 0 4px 4px;"></div>
                    </div>
                </div>
            </div>

            <!-- DNS INTELLIGENCE -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-sitemap me-2"></i>DNS Intelligence</div>
                    <div class="card-body" id="dns-results">
                        {% if results and results.phases and results.phases.dns and results.phases.dns.subdomains %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for sub in results.phases.dns.subdomains %}
                            <div
                                class="tag-item px-2 py-1 bg-black border border-secondary rounded small font-monospace text-cyber">
                                {{ sub }}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small fst-italic">No subdomains discovered.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- THREAT MATRIX -->
            <div class="col-12">
                <div class="card glass-panel mb-4">
                    <div class="card-header glass-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-biohazard me-2"></i>Threat Matrix (High Value Targets)</span>
                        {% if severity_counts['critical'] + severity_counts['high'] > 0 %}
                        <span class="badge bg-danger shadow-sm animate__animated animate__pulse animate__infinite">{{
                            severity_counts['critical'] + severity_counts['high'] }} Critical/High Issues</span>
                        {% else %}
                        <span class="badge bg-success shadow-sm"><i class="fas fa-check me-1"></i>Secure</span>
                        {% endif %}
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-dark table-sm mb-0 text-center align-middle small table-hover">
                            <thead>
                                <tr class="text-muted text-uppercase" style="background: rgba(255,255,255,0.05);">
                                    <th class="py-2 border-secondary">Port/Service</th>
                                    <th class="py-2 border-secondary">Technology Stack</th>
                                    <th class="py-2 border-secondary">Threat Detection</th>
                                    <th class="py-2 border-secondary">Data Exposure Risk</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if results and results.phases and results.phases.recon and
                                results.phases.recon.open_ports %}
                                {% for port in results.phases.recon.open_ports %}
                                {% if (port.priority_score and port.priority_score >= 50) or port.port in [80, 443,
                                8080] %}
                                <tr class="border-secondary">
                                    <td class="font-monospace text-info border-secondary">
                                        <span class="badge bg-secondary me-1">{{ port.port }}</span> {{
                                        port.service_name }}
                                    </td>
                                    <td class="border-secondary">
                                        {% set port_key = port.port|string %}
                                        {% if results.phases.enum and results.phases.enum.whatweb and
                                        results.phases.enum.whatweb[port_key] %}
                                        {% set ww = results.phases.enum.whatweb[port_key] %}
                                        <!-- Simple inline badges for the matrix -->
                                        {% if "WordPress" in ww %}<span class="badge bg-primary" title="WordPress"><i
                                                class="fab fa-wordpress"></i> WP</span>{% endif %}
                                        {% if "Apache" in ww %}<span class="badge bg-danger" title="Apache"><i
                                                class="fas fa-server"></i> Apache</span>{% endif %}
                                        {% if "Nginx" in ww %}<span class="badge bg-success" title="Nginx"><i
                                                class="fas fa-server"></i> Nginx</span>{% endif %}
                                        {% if "PHP" in ww %}<span class="badge bg-info text-dark" title="PHP"><i
                                                class="fab fa-php"></i> PHP</span>{% endif %}
                                        {% if "Microsoft-IIS" in ww %}<span class="badge bg-info" title="IIS"><i
                                                class="fab fa-windows"></i> IIS</span>{% endif %}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="border-secondary">
                                        {% if port.priority_score >= 80 %}
                                        <span class="badge bg-danger w-100 shadow-danger">CRITICAL / HIGH</span>
                                        {% elif port.priority_score >= 50 %}
                                        <span class="badge bg-warning text-dark w-100">MEDIUM / SUSPICIOUS</span>
                                        {% else %}
                                        <span class="badge bg-success w-100 opacity-50">LOW / AUDIT</span>
                                        {% endif %}
                                    </td>
                                    <td class="border-secondary">
                                        {% set sensitive = false %}
                                        {% if results.phases.enum and results.phases.enum.katana and
                                        results.phases.enum.katana[port_key] %}
                                        {% for ep in results.phases.enum.katana[port_key] %}
                                        {% if ".env" in ep or "admin" in ep %}{% set sensitive = true %}{% endif %}
                                        {% endfor %}
                                        {% endif %}

                                        {% if sensitive %}
                                        <span class="text-danger fw-bold"><i
                                                class="fas fa-exclamation-triangle me-1"></i>Exposed Secrets</span>
                                        {% else %}
                                        <span class="text-muted text-opacity-50"><i class="fas fa-check me-1"></i>No
                                            leaks detected</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4" class="py-3 text-muted">No high-risk services identified yet.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-th me-2"></i>Recon Matrix (Deep Audit)</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0"
                                style="border-collapse: separate; border-spacing: 0;">
                                <thead style="background: rgba(0,0,0,0.3);">
                                    <tr class="text-muted small text-uppercase">
                                        <th class="p-3">Service</th>
                                        <th class="p-3">Risk Score</th>
                                        <th class="p-3">Port</th>
                                        <th class="p-3">Version Fingerprint</th>
                                        <th class="p-3">Context / Technology</th>
                                        <th class="p-3 text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recon-matrix-body">
                                    {% if results and results.phases and results.phases.recon and
                                    results.phases.recon.open_ports %}
                                    {% for port in results.phases.recon.open_ports %}
                                    <tr
                                        style="border-bottom: 1px solid #333; height: 65px; vertical-align: middle; {% if port.priority_score and port.priority_score >= 80 %}background: rgba(255, 42, 42, 0.05);{% endif %}">
                                        <td class="p-3">
                                            <span
                                                class="badge bg-secondary-subtle text-secondary border border-secondary-subtle text-uppercase"
                                                style="font-size: 0.72rem; letter-spacing: 0.5px;">
                                                <i class="fas fa-server me-1 opacity-50"></i>{{ port.service_name }}
                                            </span>
                                        </td>
                                        <td class="p-3">
                                            {% set score = port.priority_score or 0 %}
                                            <div class="d-flex align-items-center">
                                                <div class="progress bg-dark border border-secondary"
                                                    style="height: 6px; width: 40px; margin-right: 10px;">
                                                    <div class="progress-bar {% if score >= 85 %}bg-danger shadow-danger{% elif score >= 50 %}bg-warning{% else %}bg-info{% endif %}"
                                                        role="progressbar" style="width: {{ score }}%"></div>
                                                </div>
                                                <span
                                                    class="badge {% if score >= 85 %}text-danger fw-bold{% elif score >= 50 %}text-warning{% else %}text-info{% endif %} font-monospace"
                                                    style="font-size: 0.8rem;">
                                                    {{ score }}<small class="opacity-50">/100</small>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="p-3">
                                            <code class="text-info fw-bold"
                                                style="font-size: 0.9rem; background: rgba(0,240,255,0.05); padding: 2px 6px; border-radius: 4px;">{{ port.port }}/tcp</code>
                                        </td>
                                        <td class="p-3">
                                            {% if port.version and port.version != "Unknown" %}
                                            <span class="text-light opacity-75 small font-monospace">{{ port.version
                                                }}</span>
                                            {% else %}
                                            <span class="text-muted fst-italic small">Fingerprinting...</span>
                                            {% endif %}
                                        </td>
                                        <td class="p-3">
                                            {% set port_key = port.port|string %}
                                            <div class="d-flex flex-wrap gap-1">
                                                <!-- Service Badge -->
                                                <span
                                                    class="badge border border-secondary bg-dark text-light font-monospace opacity-75">
                                                    {{ port.service_name|upper }}
                                                </span>

                                                <!-- Dynamic Tech Badges -->
                                                {% if results.phases.enum and results.phases.enum.whatweb and
                                                results.phases.enum.whatweb[port_key] %}
                                                {% set ww = results.phases.enum.whatweb[port_key] %}

                                                <!-- CMS Detection -->
                                                {% if "WordPress" in ww %}
                                                <span
                                                    class="badge bg-primary bg-gradient border border-primary text-white shadow-sm"
                                                    title="CMS Detected">
                                                    <i class="fab fa-wordpress me-1"></i>WordPress
                                                </span>
                                                {% endif %}
                                                {% if "Drupal" in ww %}
                                                <span
                                                    class="badge bg-info bg-gradient border border-info text-white shadow-sm">
                                                    <i class="fab fa-drupal me-1"></i>Drupal
                                                </span>
                                                {% endif %}
                                                {% if "Joomla" in ww %}
                                                <span
                                                    class="badge bg-warning bg-gradient border border-warning text-dark shadow-sm">
                                                    <i class="fab fa-joomla me-1"></i>Joomla
                                                </span>
                                                {% endif %}

                                                <!-- Server Tech -->
                                                {% if "Apache" in ww %}
                                                <span
                                                    class="badge bg-danger bg-opacity-75 border border-danger text-light">
                                                    <i class="fas fa-server me-1"></i>Apache
                                                </span>
                                                {% endif %}
                                                {% if "Nginx" in ww %}
                                                <span
                                                    class="badge bg-success bg-opacity-75 border border-success text-light">
                                                    <i class="fas fa-server me-1"></i>Nginx
                                                </span>
                                                {% endif %}
                                                {% if "Microsoft-IIS" in ww %}
                                                <span class="badge bg-info bg-opacity-75 border border-info text-light">
                                                    <i class="fab fa-windows me-1"></i>IIS
                                                </span>
                                                {% endif %}

                                                <!-- Langs -->
                                                {% if "PHP" in ww %}
                                                <span class="badge bg-info bg-opacity-50 border border-info text-light">
                                                    <i class="fab fa-php me-1"></i>PHP
                                                </span>
                                                {% endif %}

                                                <!-- Extract Title if strictly needed, or leave it cleaner -->
                                                {% if "Title[" in ww %}
                                                <span class="badge bg-dark border border-secondary text-muted small"
                                                    title="{{ ww.split('Title[')[1].split(']')[0] }}">
                                                    <i class="fas fa-heading"></i>
                                                </span>
                                                {% endif %}
                                                {% else %}
                                                <!-- No WhatWeb Data -->
                                                <span class="text-muted small opacity-25">-</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="p-3 text-end">
                                            {% if 'http' in port.service_name or port.port in [80, 443, 8080, 8443] %}
                                            {% set proto = 'https' if port.port in [443, 8443] else 'http' %}
                                            <a href="{{ proto }}://{{ scan.target.identifier }}:{{ port.port }}"
                                                target="_blank" class="btn btn-xs btn-outline-info"
                                                title="Visit Web Service">
                                                <i class="fas fa-external-link-alt me-1"></i>Visit
                                            </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="p-4 text-center text-muted">
                                            <i class="fas fa-search fa-2x mb-3"></i>
                                            <p>No attack surface identified yet. Scan in progress or target
                                                unresponsive.</p>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ATTACK VECTOR ANALYSIS -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-brain me-2"></i>Attack Vector Analysis (Intel
                        Engine)</div>
                    <div class="card-body" id="intel-results">
                        {% if results and results.phases and results.phases.intel %}
                        <div class="accordion" id="accordionIntel">
                            {% for port, vectors in results.phases.intel.items() %}
                            <div class="accordion-item bg-black border-secondary">
                                <h2 class="accordion-header" id="heading-intel-{{ port }}">
                                    <button
                                        class="accordion-button collapsed bg-dark text-light border-secondary shadow-none"
                                        type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapse-intel-{{ port }}" aria-expanded="false"
                                        aria-controls="collapse-intel-{{ port }}">
                                        <span class="badge bg-warning me-2">Port {{ port }}</span>
                                        <span class="font-monospace small text-muted">{{ vectors|length }} Vectors
                                            Identified</span>
                                    </button>
                                </h2>
                                <div id="collapse-intel-{{ port }}" class="accordion-collapse collapse"
                                    aria-labelledby="heading-intel-{{ port }}" data-bs-parent="#accordionIntel">
                                    <div class="accordion-body p-0">
                                        <div class="p-2">
                                            {% for v in vectors %}
                                            <div class="mb-2 p-2 border border-secondary rounded bg-dark-subtle">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="fw-bold text-info small">{{ v.name }}</span>
                                                    <span
                                                        class="badge {% if v.score >= 80 %}bg-danger{% else %}bg-secondary{% endif %}">Score:
                                                        {{ v.score }}</span>
                                                </div>
                                                <div class="small text-muted mb-1">{{ v.description }}</div>
                                                <div class="font-monospace x-small text-warning bg-black p-1 rounded">
                                                    Action: {{ v.action }}</div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small fst-italic">No specific attack vectors mapped.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ENUM RESULTS (WhatWeb) -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-list-ul me-2"></i>Enumeration (WhatWeb)</div>
                    <div class="card-body" id="whatweb-results">
                        {% if results and results.phases and results.phases.enum and results.phases.enum.whatweb %}
                        {% set ww = results.phases.enum.whatweb %}
                        {% if ww.summary %}
                        <div class="tag-grid d-flex flex-wrap gap-2 mb-3">
                            {% for key, value in ww.summary.items() %}
                            <div class="tag-item px-2 py-1 bg-black border border-secondary rounded small">
                                <span class="tag-key text-muted me-1">{{ key }}:</span>
                                <span class="tag-value text-cyber">{{ value }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        <div class="whatweb-details">
                            {% for port, output in ww.items() %}
                            {% if port != 'summary' %}
                            <div
                                class="whatweb-entry small font-monospace text-muted border-bottom border-dark pb-1 mb-2 text-break">
                                <span class="badge bg-secondary me-2">Port {{ port }}</span> {{ output }}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small fst-italic">No enumeration summary available.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- DEEP CRAWLING (Katana) -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-spider me-2"></i>Deep Crawling (Katana)</div>
                    <div class="card-body" id="katana-results">
                        {% if results and results.phases and results.phases.enum and results.phases.enum.katana %}
                        <div class="accordion" id="accordionKatana">
                            {% for port, endpoints in results.phases.enum.katana.items() %}
                            <div class="accordion-item bg-black border-secondary">
                                <h2 class="accordion-header" id="heading-katana-{{ port }}">
                                    <button
                                        class="accordion-button collapsed bg-dark text-light border-secondary shadow-none"
                                        type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapse-katana-{{ port }}" aria-expanded="false"
                                        aria-controls="collapse-katana-{{ port }}">
                                        <span class="badge bg-info me-2">Port {{ port }}</span>
                                        <span class="font-monospace small text-muted">{{ endpoints|length }} Endpoints
                                            Discovered</span>
                                    </button>
                                </h2>
                                <div id="collapse-katana-{{ port }}" class="accordion-collapse collapse"
                                    aria-labelledby="heading-katana-{{ port }}" data-bs-parent="#accordionKatana">
                                    <div class="accordion-body p-0">
                                        <div class="p-2" style="max-height: 300px; overflow-y: auto;">
                                            {% for ep in endpoints %}
                                            {% set ep_lower = ep|lower %}
                                            {% set is_crit = ".env" in ep_lower or ".git" in ep_lower or "config" in
                                            ep_lower or ".bak" in ep_lower or ".sql" in ep_lower or ".db" in ep_lower %}
                                            {% set is_admin = "admin" in ep_lower or "login" in ep_lower or "dashboard"
                                            in ep_lower or "setup" in ep_lower %}
                                            {% set is_js = ".js" in ep_lower %}
                                            {% set is_img = ".jpg" in ep_lower or ".png" in ep_lower or ".gif" in
                                            ep_lower or ".svg" in ep_lower or ".ico" in ep_lower or ".css" in ep_lower
                                            %}

                                            <div
                                                class="small font-monospace mb-1 border-bottom border-dark pb-1 text-break d-flex align-items-center">
                                                {% if is_crit %}
                                                <i class="fas fa-radiation text-danger me-2" title="CRITICAL ASSET"></i>
                                                <a href="{{ ep }}" target="_blank"
                                                    class="text-decoration-none text-danger fw-bold hover-action">{{ ep
                                                    }}</a>
                                                {% elif is_admin %}
                                                <i class="fas fa-user-shield text-warning me-2"
                                                    title="Admin Interface"></i>
                                                <a href="{{ ep }}" target="_blank"
                                                    class="text-decoration-none text-warning hover-action">{{ ep }}</a>
                                                {% elif is_js %}
                                                <i class="fab fa-js text-info opacity-50 me-2" style="width: 16px;"></i>
                                                <a href="{{ ep }}" target="_blank"
                                                    class="text-decoration-none text-info opacity-75 hover-action">{{ ep
                                                    }}</a>
                                                {% elif is_img %}
                                                <i class="fas fa-image text-secondary opacity-25 me-2"
                                                    style="width: 16px;"></i>
                                                <a href="{{ ep }}" target="_blank"
                                                    class="text-decoration-none text-secondary opacity-50 hover-action">{{
                                                    ep }}</a>
                                                {% else %}
                                                <i class="fas fa-link text-muted opacity-25 me-2"
                                                    style="width: 16px;"></i>
                                                <a href="{{ ep }}" target="_blank"
                                                    class="text-decoration-none text-cyber hover-action">{{ ep }}</a>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small fst-italic">No crawling results yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- NUCLEI RESULTS -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-bug me-2"></i>Vulnerability Mapping (Nuclei)
                    </div>
                    <div class="card-body" id="nuclei-results">
                        {% if results and results.phases and results.phases.vuln and results.phases.vuln.nuclei and
                        results.phases.vuln.nuclei.findings %}
                        <div class="result-list">
                            {% for finding in results.phases.vuln.nuclei.findings %}
                            <div
                                class="result-row p-2 mb-2 bg-black border border-secondary rounded d-flex align-items-center justify-content-between">
                                <span class="badge severity-badge {{ finding.severity }} me-2 text-uppercase">{{
                                    finding.severity }}</span>
                                <span class="result-text flex-grow-1">{{ finding.title }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small fst-italic">No vulnerabilities reported.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- FFUF RESULTS -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header"><i class="fas fa-folder-open me-2"></i>Dirbusting (ffuf)</div>
                    <div class="card-body" id="ffuf-results">
                        {% if results and results.phases and results.phases.dirbusting and
                        results.phases.dirbusting.ffuf and results.phases.dirbusting.ffuf.endpoints %}
                        <div class="result-list">
                            {% for endpoint in results.phases.dirbusting.ffuf.endpoints %}
                            <div
                                class="result-row p-2 mb-2 bg-black border border-secondary rounded d-flex justify-content-between">
                                <span class="badge bg-secondary font-monospace">/{{ endpoint.path }}</span>
                                <span class="result-text small text-muted">Status {{ endpoint.status }} Â· Size {{
                                    endpoint.size }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small fst-italic">No endpoints discovered.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- EXECUTION LOG -->
            <div class="col-12">
                <div class="card glass-panel">
                    <div class="card-header glass-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-terminal me-2"></i>Execution Log</span>
                        <span id="socket-status" class="badge bg-secondary"
                            style="font-size: 0.6rem;">connecting...</span>
                    </div>
                    <div class="card-body font-monospace log-console"
                        style="max-height: 400px; min-height: 300px; overflow-y: auto; background: #000;">
                        {% if logs %}
                        {% for log in logs %}
                        <div>
                            <span class="text-muted opacity-50">[{{ log.timestamp.strftime('%H:%M:%S') }}]</span>
                            <span
                                class="{% if log.level == 'INFO' %}text-secondary{% elif log.level == 'SUCCESS' %}text-success{% elif log.level == 'WARN' %}text-warning{% elif log.level == 'ERROR' %}text-danger{% else %}text-secondary{% endif %}">{{
                                log.level }}</span>
                            {{ log.message }}
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-muted">No logs recorded.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR / UTILITIES -->
    <div class="col-lg-4">
        <!-- RAW OUTPUT -->
        <div class="card glass-panel mb-4 text-secondary" style="font-size: 0.8rem;">
            <div class="card-header glass-header py-1" data-bs-toggle="collapse" data-bs-target="#rawOutput"
                style="cursor: pointer; opacity: 0.7;">
                <i class="fas fa-terminal me-2"></i>Raw Nmap View
            </div>
            <div id="rawOutput" class="collapse">
                <div class="card-body bg-black p-2">
                    <pre class="m-0"
                        style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; font-size: 0.7rem;">{{ results.phases.recon.raw_output if results and results.phases and results.phases.recon else 'No raw output.' }}</pre>
                </div>
            </div>
        </div>

        <!-- FINDINGS -->
        <div class="card glass-panel mb-4">
            <div class="card-header glass-header"><i class="fas fa-bell me-2"></i>Findings</div>
            <div class="card-body" id="findings-container" style="max-height: 600px; overflow-y: auto;">
                {% if findings %}
                <div class="result-list">
                    {% for finding in findings %}
                    <div
                        class="result-row flex-column align-items-start p-3 mb-2 bg-black border border-secondary rounded position-relative hover-highlight">
                        <div class="d-flex w-100 justify-content-between mb-2">
                            <span class="badge severity-badge {{ finding.severity }} text-uppercase">{{
                                finding.severity
                                }}</span>
                            <span class="result-text fw-bold text-break">{{ finding.title }}</span>
                        </div>
                        {% if finding.description %}
                        <div class="mt-1 small text-muted text-break overflow-auto"
                            style="max-height: 200px; white-space: pre-wrap;">{{
                            finding.description }}</div>
                        {% endif %}
                        {% if finding.screenshot_path %}
                        <div class="mt-2 w-100">
                            <img src="{{ url_for('static', filename=finding.screenshot_path) }}"
                                class="img-fluid rounded border border-secondary shadow-sm"
                                style="max-height: 150px; cursor: pointer;" onclick="window.open(this.src)">
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-muted">No findings recorded.</div>
                {% endif %}
            </div>
        </div>

        <!-- SUGGESTIONS -->
        <div class="card glass-panel mb-4">
            <div class="card-header glass-header"><i class="fas fa-lightbulb me-2"></i>Suggestions</div>
            <div class="card-body" id="suggestions-container">
                {% if suggestions %}
                <div class="result-list">
                    {% for suggestion in suggestions %}
                    <div
                        class="result-row d-flex justify-content-between align-items-center p-2 mb-2 bg-black border border-secondary rounded">
                        <div>
                            <span class="badge bg-secondary me-2">{{ suggestion.tool_name }}</span>
                            <span class="result-text font-monospace small">{{ suggestion.command_suggestion
                                }}</span>
                            {% if suggestion.reason %}
                            <div class="mt-1 x-small text-muted opacity-50">{{ suggestion.reason }}</div>
                            {% endif %}
                        </div>
                        <button class="btn btn-xs btn-outline-warning"
                            onclick='verifyFinding({{ suggestion.command_suggestion|tojson|safe }})'>
                            <i class="fas fa-play me-1"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-muted">No suggestions recorded.</div>
                {% endif %}
            </div>
        </div>

        <!-- NOTES -->
        <div class="card glass-panel mb-4">
            <div class="card-header glass-header"><i class="fas fa-sticky-note me-2"></i>Operator Notes (War Room)
            </div>
            <div class="card-body">
                <form action="{{ url_for('main.update_notes', scan_id=scan.id) }}" method="POST">
                    <textarea name="notes" class="form-control bg-dark text-light border-secondary mb-2" rows="6"
                        placeholder="Document your findings... Markdown supported">{{ scan.notes or '' }}</textarea>
                    <div class="text-end">
                        <button type="submit" class="btn btn-sm btn-outline-success">Save Notes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Harvest Loot -->
<div class="modal fade" id="harvestLootModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning"><i class="fas fa-sack-dollar me-2"></i>Harvest Mission Loot
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.loot_add', scan_id=scan.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Loot Type</label>
                        <select name="type" class="form-select bg-black text-light border-secondary">
                            <option value="credential">Credential (User/Pass)</option>
                            <option value="token">Token / API Key</option>
                            <option value="file">Sensitive File Path</option>
                            <option value="other">Other Asset</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Content</label>
                        <textarea name="content"
                            class="form-control bg-black text-light border-secondary font-monospace" rows="2"
                            placeholder="admin:P@ssword123" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Context</label>
                        <input type="text" name="context" class="form-control bg-black text-light border-secondary"
                            placeholder="e.g. /etc/passwd">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-warning">Store in Vault</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Node Details -->
<div class="modal fade" id="nodeDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title font-monospace text-info" id="nodeDetailTitle">Node Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body" id="nodeDetailBody"></div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const scanId = "{{ scan.id }}";
        const targetLabel = "{{ scan.target.identifier }}";
        const socket = io();
        const statusEl = document.getElementById('socket-status');

        socket.on('connect', () => {
            console.log("Socket connected, joining room: scan_" + scanId);
            if (statusEl) {
                statusEl.innerText = "connected";
                statusEl.className = "badge bg-success";
            }
            socket.emit('join_scan', { scan_id: scanId });
        });

        socket.on('connect_error', (error) => {
            console.error("Socket Connection Error:", error);
            if (statusEl) {
                statusEl.innerText = "offline";
                statusEl.className = "badge bg-danger";
            }
        });

        socket.on('disconnect', () => {
            if (statusEl) {
                statusEl.innerText = "reconnecting...";
                statusEl.className = "badge bg-warning";
            }
        });

        // --- PTES NAVIGATION HIGHLIGHTER ---
        const ptesMap = {
            'Phase 1': 'recon',
            'Phase 2': 'recon',
            'Phase 3': 'recon',
            'Phase 4': 'enum',
            'Phase 5': 'vuln',
            'Phase 6': 'initial',
            'Phase 7': 'privesc',
            'Phase 8': 'lateral',
            'Phase 9': 'postex'
        };

        function highlightPTES(text) {
            for (const [phaseKey, ptesIdSuffix] of Object.entries(ptesMap)) {
                if (text.includes(phaseKey)) {
                    document.querySelectorAll('.nav-link[id^="sidebar-ptes-"]').forEach(el => el.classList.remove('active'));
                    const target = document.getElementById(`sidebar-ptes-${ptesIdSuffix}`);
                    if (target) {
                        target.classList.add('active');
                    }
                    break;
                }
            }
        }

        // --- SCAN TOAST CONTROLLER ---
        function toggleScanToast(isRunning) {
            const toast = document.getElementById('scan-toast');
            if (!toast) return;
            if (isRunning) {
                toast.classList.add('visible');
            } else {
                toast.classList.remove('visible');
            }
        }

        // Initial Checks
        const statusPill = document.querySelector('.status-pill');
        const currentStatus = statusPill ? statusPill.innerText.toLowerCase() : '';
        toggleScanToast(currentStatus === 'running');

        document.querySelectorAll('.log-console > div').forEach(logDiv => {
            highlightPTES(logDiv.innerText);
        });

        // --- REAL-TIME UPDATES ---
        socket.on("new_log", function (data) {
            if (data.scan_id == scanId) {
                const consoleDiv = document.querySelector(".log-console");
                if (consoleDiv) {
                    // Remove "No logs recorded" if present
                    const emptyMsg = consoleDiv.querySelector(".text-muted");
                    if (emptyMsg && emptyMsg.innerText.includes("No logs")) {
                        emptyMsg.remove();
                    }

                    const div = document.createElement("div");
                    const levelClass = data.level === 'SUCCESS' ? 'text-success' : (data.level === 'WARN' ? 'text-warning' : (data.level === 'ERROR' ? 'text-danger' : 'text-secondary'));
                    div.innerHTML = `<span class="text-muted">[${data.timestamp}]</span> <span class="${levelClass}">${data.level}</span> ${data.message}`;
                    consoleDiv.appendChild(div);
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                }
                highlightPTES(data.message);
                if (data.message.includes("Scan finished")) {
                    const sp = document.querySelector('.status-pill');
                    if (sp) {
                        sp.innerText = 'finished';
                        sp.className = 'badge status-pill status-finished ms-2';
                    }
                    toggleScanToast(false);
                }
            }
        });

        socket.on("results_update", function (msg) {
            if (msg.scan_id == scanId && window.updateUI) {
                window.updateUI(msg.results);
            }
        });

        socket.on("new_finding", function (data) {
            if (data.scan_id == scanId) {
                const container = document.getElementById("findings-container");
                if (container) {
                    const empty = container.querySelector(".text-muted");
                    if (empty && empty.innerText.includes("No findings")) empty.remove();

                    let list = container.querySelector(".result-list");
                    if (!list) {
                        list = document.createElement("div");
                        list.className = "result-list";
                        container.appendChild(list);
                    }

                    const div = document.createElement("div");
                    div.className = "result-row flex-column align-items-start p-3 mb-2 bg-black border border-secondary rounded position-relative hover-highlight animate__animated animate__fadeInLeft";
                    div.innerHTML = `
                        <div class="d-flex w-100 justify-content-between mb-2">
                            <span class="badge severity-badge ${data.severity}">${data.severity.toUpperCase()}</span>
                            <span class="result-text fw-bold text-break">${data.title}</span>
                        </div>
                        <div class="mt-1 small text-muted text-break">Source: ${data.tool}</div>
                    `;
                    list.prepend(div);
                }
            }
        });

        socket.on("new_suggestion", function (data) {
            if (data.scan_id == scanId) {
                const container = document.getElementById("suggestions-container");
                if (container) {
                    const empty = container.querySelector(".text-muted");
                    if (empty && empty.innerText.includes("No suggestions")) empty.remove();

                    let list = container.querySelector(".result-list");
                    if (!list) {
                        list = document.createElement("div");
                        list.className = "result-list";
                        container.appendChild(list);
                    }

                    const div = document.createElement("div");
                    div.className = "result-row d-flex justify-content-between align-items-center p-2 mb-2 bg-black border border-secondary rounded animate__animated animate__fadeInUp";
                    div.innerHTML = `
                        <div>
                            <span class="badge bg-secondary me-2">${data.tool_name}</span>
                            <span class="result-text font-monospace small">${data.command_suggestion}</span>
                        </div>
                        <button class="btn btn-xs btn-outline-warning" onclick='verifyFinding("${data.command_suggestion}")'>
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                    list.prepend(div);
                }
            }
        });

        socket.on("progress_update", function (data) {
            if (data.scan_id == scanId) {
                const bar = document.getElementById('scan-progress-bar');
                const phaseText = document.getElementById('scan-phase-text');
                const statusText = document.getElementById('scan-status-text');
                const spinner = document.getElementById('scan-spinner');

                if (bar) {
                    bar.style.width = data.percent + '%';
                    bar.setAttribute('aria-valuenow', data.percent);
                }
                if (phaseText) phaseText.innerText = data.current_phase;

                if (data.percent >= 100) {
                    if (statusText) statusText.innerText = 'completed';
                    if (spinner) spinner.classList.add('d-none');
                    if (bar) {
                        bar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                        bar.classList.add('bg-success');
                    }
                    toggleScanToast(false);
                } else {
                    if (statusText) statusText.innerText = 'running';
                    if (spinner) spinner.classList.remove('d-none');
                    toggleScanToast(true);
                }
            }
        });

        // --- VERIFICATION ENGINE ---
        window.verifyFinding = function (command) {
            if (!confirm(`ExÃ©cuter la vÃ©rification: ${command}?`)) return;
            fetch('/scan/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scan_id: scanId, command: command })
            }).then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        alert("TÃ¢che de vÃ©rification lancÃ©e. Surveillez les logs.");
                    }
                });
        };

        // --- VISUALIZATION (Graph) ---
        let network = null;
        let nodes = new vis.DataSet([]);
        let edges = new vis.DataSet([]);

        function initGraph() {
            const container = document.getElementById("network-graph");
            if (!container) return;
            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: { borderWidth: 2, shadow: true, font: { color: "#fff", face: "JetBrains Mono", size: 12 } },
                edges: { smooth: { type: 'continuous' }, color: { color: "#444" } },
                physics: { stabilization: false, barnesHut: { gravitationalConstant: -2000 } },
                interaction: { hover: true, zoomView: true }
            };
            network = new vis.Network(container, data, options);
            network.on("click", function (p) {
                if (p.nodes.length) showNodeDetails(p.nodes[0]);
            });
        }

        function showNodeDetails(nodeId) {
            const node = nodes.get(nodeId);
            const title = document.getElementById("nodeDetailTitle");
            const body = document.getElementById("nodeDetailBody");
            if (!node || !title || !body) return;

            title.innerText = node.label.replace("\n", " ");
            let content = '<div class="p-4">';

            if (nodeId.toString().startsWith('p')) {
                const portNum = nodeId.replace('p', '');
                content += `
                    <div class="d-flex align-items-center mb-4">
                        <div class="display-4 text-info fw-bold me-3">${portNum}</div>
                        <div>
                            <div class="text-uppercase text-muted small">Port Status</div>
                            <div class="badge bg-success">OPEN / ACTIVE</div>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="p-3 bg-black rounded border border-secondary text-center">
                                <i class="fas fa-server fa-2x text-secondary mb-2"></i>
                                <div class="small text-muted">Service</div>
                                <div class="fw-bold">${node.label.split('\n')[1] || 'Unknown'}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-black rounded border border-secondary text-center">
                                <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
                                <div class="small text-muted">Risk Profile</div>
                                <div class="fw-bold text-warning">MATCHED</div>
                            </div>
                        </div>
                    </div>`;
            } else {
                content += `<div class="text-center py-4"><i class="fas fa-bullseye fa-3x text-danger mb-3"></i><h4>Target Identification</h4><p class="text-muted">${node.label}</p></div>`;
            }
            content += '</div>';
            body.innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('nodeDetailModal'));
            modal.show();
        }

        // --- UI UPDATE ENGINE ---
        window.updateUI = function (results) {
            if (!results || !results.phases) return;

            // 1. DNS
            if (results.phases.dns && results.phases.dns.subdomains) {
                const dnsDiv = document.querySelector("#dns-results");
                if (dnsDiv) {
                    let dnsHtml = '<div class="d-flex flex-wrap gap-2">';
                    results.phases.dns.subdomains.forEach(sub => {
                        dnsHtml += `<div class="tag-item px-2 py-1 bg-black border border-secondary rounded small font-monospace text-cyber">${sub}</div>`;
                    });
                    dnsHtml += '</div>';
                    dnsDiv.innerHTML = dnsHtml || '<div class="text-muted small fst-italic">No subdomains discovered.</div>';
                }
            }

            // 2. Recon Matrix
            const matrixBody = document.querySelector("#recon-matrix-body");
            if (matrixBody && results.phases.recon && results.phases.recon.open_ports) {
                let html = "";
                const ports = results.phases.recon.open_ports.sort((a, b) => (b.priority_score || 0) - (a.priority_score || 0));

                ports.forEach(port => {
                    const score = port.priority_score || 0;
                    const scoreClass = score >= 85 ? 'text-danger fw-bold' : (score >= 50 ? 'text-warning' : 'text-info');
                    const barClass = score >= 85 ? 'bg-danger shadow-danger' : (score >= 50 ? 'bg-warning' : 'bg-info');
                    const bgStyle = score >= 80 ? 'background: rgba(255, 42, 42, 0.05);' : '';
                    const isWeb = (port.port == 80 || port.port == 443 || port.port == 8080 || port.port == 8443);
                    const proto = (port.port == 443 || port.port == 8443) ? 'https' : 'http';

                    let techHtml = '<span class="text-muted small">-</span>';
                    const portKey = port.port.toString();
                    if (results.phases.enum && results.phases.enum.whatweb && results.phases.enum.whatweb[portKey]) {
                        const ww = results.phases.enum.whatweb[portKey];
                        techHtml = '<div class="d-flex flex-wrap gap-1">';
                        if (ww.includes('Title[')) {
                            const title = ww.split('Title[')[1].split(']')[0];
                            techHtml += `<span class="badge rounded-pill bg-dark border border-secondary text-info x-small">${title.substring(0, 15)}...</span>`;
                        }
                        if (ww.includes('HTTPServer[')) {
                            const server = ww.split('HTTPServer[')[1].split(']')[0];
                            techHtml += `<span class="badge rounded-pill bg-dark border border-secondary text-warning x-small">${server}</span>`;
                        }
                        techHtml += '</div>';
                    }

                    html += `<tr style="border-bottom: 1px solid #333; height: 65px; vertical-align: middle; ${bgStyle}">
                        <td class="p-3"><span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle text-uppercase">${port.service_name}</span></td>
                        <td class="p-3">
                            <div class="d-flex align-items-center">
                                <div class="progress bg-dark border border-secondary" style="height: 6px; width: 40px; margin-right: 10px;">
                                    <div class="progress-bar ${barClass}" style="width: ${score}%"></div>
                                </div>
                                <span class="badge ${scoreClass} font-monospace" style="font-size: 0.75rem;">${score}</span>
                            </div>
                        </td>
                        <td class="p-3"><code class="text-info fw-bold">${port.port}/tcp</code></td>
                        <td class="p-3"><span class="text-light opacity-75 small font-monospace">${port.version || '-'}</span></td>
                        <td class="p-3">${techHtml}</td>
                        <td class="p-3 text-end">
                            ${isWeb ? `<a href="${proto}://${targetLabel}:${port.port}" target="_blank" class="btn btn-xs btn-outline-info"><i class="fas fa-external-link-alt"></i></a>` : ''}
                        </td>
                    </tr>`;
                });
                matrixBody.innerHTML = html;
            }

            // 3. Network Graph
            if (results.phases.recon && results.phases.recon.open_ports) {
                if (!network) initGraph();
                if (!nodes.get(0)) nodes.add({ id: 0, label: targetLabel, color: "#ff2a2a", shape: "hexagon", size: 40 });
                results.phases.recon.open_ports.forEach(port => {
                    const pId = "p" + port.port;
                    if (!nodes.get(pId)) {
                        nodes.add({ id: pId, label: port.port + "\n" + port.service_name, color: "#00f0ff", shape: "dot", size: 15 });
                        edges.add({ from: 0, to: pId });
                    }
                });
            }

            // 4. Intel
            if (results.phases.intel) {
                const intelDiv = document.querySelector("#intel-results");
                if (intelDiv) {
                    let intelHtml = '<div class="accordion" id="accordionIntel">';
                    for (const [port, vectors] of Object.entries(results.phases.intel)) {
                        intelHtml += `
                            <div class="accordion-item bg-black border-secondary">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed bg-dark text-light border-secondary shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-intel-${port}">
                                        <span class="badge bg-warning me-2">Port ${port}</span>
                                        <span class="font-monospace small text-muted">${vectors.length} Vectors</span>
                                    </button>
                                </h2>
                                <div id="collapse-intel-${port}" class="accordion-collapse collapse" data-bs-parent="#accordionIntel">
                                    <div class="accordion-body p-2">
                                        ${vectors.map(v => `
                                            <div class="mb-2 p-2 border border-secondary rounded bg-dark-subtle">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span class="fw-bold text-info small">${v.name}</span>
                                                    <span class="badge ${v.score >= 80 ? 'bg-danger' : 'bg-secondary'}">${v.score}</span>
                                                </div>
                                                <div class="small text-muted mb-1">${v.description}</div>
                                                <div class="font-monospace x-small text-warning bg-black p-1 rounded">Action: ${v.action}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>`;
                    }
                    intelHtml += '</div>';
                    intelDiv.innerHTML = Object.keys(results.phases.intel).length ? intelHtml : '<div class="text-muted small fst-italic">Analyzing vectors...</div>';
                }
            }

            // 5. WhatWeb
            if (results.phases.enum && results.phases.enum.whatweb) {
                const wwDiv = document.querySelector("#whatweb-results");
                if (wwDiv) {
                    let wwHtml = "";
                    const wwData = results.phases.enum.whatweb;
                    if (wwData.summary) {
                        wwHtml += '<div class="tag-grid d-flex flex-wrap gap-2 mb-3">';
                        for (const [k, v] of Object.entries(wwData.summary)) {
                            wwHtml += `<div class="tag-item px-2 py-1 bg-black border border-secondary rounded small"><span class="tag-key text-muted me-1">${k}:</span><span class="tag-value text-cyber">${v}</span></div>`;
                        }
                        wwHtml += '</div>';
                    }
                    for (const [port, output] of Object.entries(wwData)) {
                        if (port !== 'summary') {
                            wwHtml += `<div class="whatweb-entry small font-monospace text-muted border-bottom border-dark pb-1 mb-2 text-break"><span class="badge bg-secondary me-2">Port ${port}</span> ${output}</div>`;
                        }
                    }
                    wwDiv.innerHTML = wwHtml || '<div class="text-muted small fst-italic">Waiting for fingerprinter...</div>';
                }
            }

            // 6. Katana
            if (results.phases.enum && results.phases.enum.katana) {
                const katDiv = document.querySelector("#katana-results");
                if (katDiv) {
                    let katHtml = '<div class="accordion" id="accordionKatana">';
                    for (const [port, endpoints] of Object.entries(results.phases.enum.katana)) {
                        katHtml += `
                            <div class="accordion-item bg-black border-secondary">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed bg-dark text-light border-secondary shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-katana-${port}">
                                        <span class="badge bg-info me-2">Port ${port}</span>
                                        <span class="font-monospace small text-muted">${endpoints.length} Endpoints</span>
                                    </button>
                                </h2>
                                <div id="collapse-katana-${port}" class="accordion-collapse collapse" data-bs-parent="#accordionKatana">
                                    <div class="accordion-body p-2" style="max-height: 200px; overflow-y: auto;">
                                        ${endpoints.map(ep => `<div class="small font-monospace text-muted mb-1 border-bottom border-dark pb-1 text-break"><a href="${ep}" target="_blank" class="text-decoration-none text-cyber">${ep}</a></div>`).join('')}
                                    </div>
                                </div>
                            </div>`;
                    }
                    katHtml += '</div>';
                    katDiv.innerHTML = Object.keys(results.phases.enum.katana).length ? katHtml : '<div class="text-muted small fst-italic">No crawling results yet.</div>';
                }
            }

            // 7. Nuclei
            if (results.phases.vuln && results.phases.vuln.nuclei) {
                const nucDiv = document.querySelector("#nuclei-results");
                if (nucDiv) {
                    const findings = results.phases.vuln.nuclei.findings || [];
                    let nucHtml = '<div class="result-list">';
                    findings.forEach(f => {
                        nucHtml += `
                        <div class="result-row p-2 mb-2 bg-black border border-secondary rounded d-flex align-items-center justify-content-between animate__animated animate__fadeIn">
                            <span class="badge severity-badge ${f.severity} me-2 text-uppercase">${f.severity}</span>
                            <span class="result-text flex-grow-1 small">${f.title}</span>
                        </div>`;
                    });
                    nucHtml += '</div>';
                    nucDiv.innerHTML = findings.length ? nucHtml : '<div class="text-muted small fst-italic">No vulnerabilities reported.</div>';
                }
            }

            // 8. ffuf
            if (results.phases.dirbusting && results.phases.dirbusting.ffuf) {
                const ffufDiv = document.querySelector("#ffuf-results");
                if (ffufDiv) {
                    const endpoints = results.phases.dirbusting.ffuf.endpoints || [];
                    let ffufHtml = '<div class="result-list">';
                    endpoints.forEach(ep => {
                        ffufHtml += `
                            <div class="result-row p-2 mb-2 bg-black border border-secondary rounded d-flex justify-content-between animate__animated animate__fadeIn">
                                <span class="badge bg-secondary font-monospace" style="font-size: 0.7rem;">/${ep.path}</span>
                                <span class="result-text small text-muted">Status ${ep.status} Â· Size ${ep.size}</span>
                            </div>`;
                    });
                    ffufHtml += '</div>';
                    ffufDiv.innerHTML = endpoints.length ? ffufHtml : '<div class="text-muted small fst-italic">No endpoints discovered.</div>';
                }
            }
        };

        // Initial Load
        {% if results %}
        setTimeout(() => { window.updateUI({{ results| tojson | safe }}); }, 500);
    {% endif %}

    // Markdown Notes Preview
    const notesArea = document.querySelector('textarea[name="notes"]');
    if (notesArea) {
        const preview = document.createElement('div');
        preview.className = "p-3 bg-black border border-secondary rounded mt-2 text-muted small";
        notesArea.parentNode.insertBefore(preview, notesArea.nextSibling);
        const updatePreview = () => { preview.innerHTML = DOMPurify.sanitize(marked.parse(notesArea.value || "*No notes recorded.*")); };
        notesArea.addEventListener('input', updatePreview);
        updatePreview();
    }
    });
</script>
{% endblock %}